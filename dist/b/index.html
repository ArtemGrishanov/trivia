<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="theme-color" content="#000000" />
    <title>Trivia App</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <script>
        var __REMIX_DEFAULT_PROPERTIES__ = '{{PROJECT_STRUCTURE_JSON}}';
    </script>
    <div id="remix-app-root"></div>
    <script>
        var loadStatus = 0, loadStuff = 0, cntOrigin, cntSource, inited = false;
        function checkAndReply(loaded) {
            if (loaded) loadStatus++;
            // send 'embedded' back to RemixContainer
            if (cntSource && loadStatus === loadStuff) {
              cntSource.postMessage({ method: 'embedded' }, cntOrigin);
            }
        }
        function receiveMessage({origin = null, data = {}, source = null}) {
            // if (data.method) {
            //     console.log('App index.html says: ' + data.method + ' message received');
            // }
            var EXPECTED_CONTAINER_ORIGIN = null; //TODO define origin for production
            if (EXPECTED_CONTAINER_ORIGIN && origin !== EXPECTED_CONTAINER_ORIGIN) {
                return;
            }
            if (data.method === 'embed') {
                if (data.script) {
                    loadStuff++;
                    // add additional script into loaded app iframe
                    var sc = document.createElement('script');
                    sc.onload = checkAndReply.bind(this, true);
                    sc.setAttribute('src', data.script);
                    document.body.appendChild(sc);
                }
                if (data.css) {
                    loadStuff++;
                    var st = document.createElement('style');
                    st.onload = checkAndReply.bind(this, true);
                    st.type = 'text/css';
                    st.setAttribute('src', data.css);
                    document.head.appendChild(st);
                }
                cntSource = source;
                cntOrigin = origin;
                checkAndReply();
            }
            else if (data.method === 'init' && !inited) {
                if (!window.Remix) {
                    throw new Error('Remix app not loaded! Be sure you passed correct script url.');
                }
                inited = true;
                Remix.init({
                    appStore: store,
                    container: document.getElementById('remix-app-root'),
                    mode: data.mode,
                    log: data.log,
                    defaultProperties: data.defaults,
                    origin: origin,
                    source: source
                });
                if (cntSource) {
                    cntSource.postMessage({
                        method: 'inited',
                        initialProperties: Remix.getProperties(),
                        schema: Remix._getSchema(),
                        state: Remix.serialize2(),
                        screens: Remix.getScreens(),
                    }, cntOrigin);
                }
            }
        }
        if (window.location.search.indexOf('testlocal') >= 0) {
            // run in browser 'http://localhost:8082/?testlocal'
            // runs as single app, no editor. Expect main + defaults on the same host
            receiveMessage({data:{
                method: 'embed',
                script: window.location.origin+'/main.js'
            }})
            setTimeout(function() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', window.location.origin+'/defaults.json');
                xhr.send()
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        receiveMessage({data:{
                            method: 'init',
                            defaults: xhr.responseText
                        }});
                    }
                }
            },500)
        }
        else {
            // normal launch in RContainer
            window.addEventListener("message", receiveMessage, false);
        }
    </script>
  </body>
</html>
